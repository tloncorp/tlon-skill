#!/usr/bin/env bash
set -euo pipefail

# tlon-run: Safe wrapper for Tlon skill scripts (read-only operations)
# Designed for use by LLM agents without exec privileges

SKILL_DIR="${TLON_SKILL_DIR:-/usr/local/share/moltbot/skills/tlon}"
TS_NODE="$SKILL_DIR/node_modules/.bin/ts-node"
PIER_ROOT="${PIER_ROOT:-/pier}"

# Hard fail if ts-node isn't present
[ -x "$TS_NODE" ] || { echo "error: tlon-skill not installed at $SKILL_DIR"; exit 2; }

# Export skill dir for TypeScript scripts
export TLON_SKILL_DIR="$SKILL_DIR"

# Auto-initialize ship configs if none exist and we're in a pier environment
init_ships_if_needed() {
  local ships_dir="$SKILL_DIR/ships"
  local has_configs=false

  # Check if any real config files exist (not example.json)
  if [ -d "$ships_dir" ]; then
    for f in "$ships_dir"/*.json; do
      [ -f "$f" ] || continue
      [ "$(basename "$f")" = "example.json" ] && continue
      has_configs=true
      break
    done
  fi

  # If no configs and pier exists, run init
  if [ "$has_configs" = false ] && [ -d "$PIER_ROOT" ]; then
    local init_script="$SKILL_DIR/scripts/init-ships.mjs"
    if [ -f "$init_script" ]; then
      echo "[tlon-run] no ship configs found, initializing from $PIER_ROOT..."
      node "$init_script" || { echo "error: failed to initialize ship configs"; exit 2; }
    fi
  fi
}

# Handle --ship flag (must be first argument)
if [ "${1:-}" = "--ship" ]; then
  TLON_SHIP="${2:-}"
  [ -n "$TLON_SHIP" ] || { echo "error: --ship requires a ship name"; exit 2; }
  shift 2
fi

# Auto-init before checking for ship config
init_ships_if_needed

# If no TLON_SHIP specified, try to auto-detect from available configs
if [ -z "${TLON_SHIP:-}" ]; then
  ships_dir="$SKILL_DIR/ships"
  if [ -d "$ships_dir" ]; then
    # Find first non-example config
    for f in "$ships_dir"/*.json; do
      [ -f "$f" ] || continue
      [ "$(basename "$f")" = "example.json" ] && continue
      # Extract ship name from filename
      TLON_SHIP="$(basename "$f" .json)"
      break
    done
  fi
fi

# Validate ship config exists (if TLON_SHIP is set)
if [ -n "${TLON_SHIP:-}" ]; then
  SHIP_FILE="$SKILL_DIR/ships/${TLON_SHIP#\~}.json"
  [ -f "$SHIP_FILE" ] || { echo "error: ship config not found: $SHIP_FILE"; exit 2; }
  export TLON_SHIP="${TLON_SHIP#\~}"
fi

# Validation helpers
validate_ship() {
  local ship="$1"
  # Urbit ship names: ~prefix or ~prefix-suffix-... (2-6 syllables)
  [[ "$ship" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}$ ]] || { echo "error: invalid ship name '$ship'"; exit 2; }
}

validate_group() {
  local grp="$1"
  # Group format: ~host-ship/slug (slug is alphanumeric with hyphens)
  [[ "$grp" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid group '$grp'"; exit 2; }
}

validate_channel() {
  local chan="$1"
  # Channel format: type/~host/slug where type is chat|diary|heap
  [[ "$chan" =~ ^(chat|diary|heap)/~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid channel '$chan'"; exit 2; }
}

validate_limit() {
  local limit="$1"
  local max="${2:-25}"
  [[ "$limit" =~ ^[0-9]+$ ]] || { echo "error: limit must be a number"; exit 2; }
  [ "$limit" -ge 1 ] || { echo "error: limit must be at least 1"; exit 2; }
  [ "$limit" -le "$max" ] || { echo "error: limit cannot exceed $max"; exit 2; }
}

# Get command
cmd="${1:-}"
shift || true

case "$cmd" in
  init)
    # Force re-initialization of ship configs
    echo "[tlon-run] initializing ship configs from $PIER_ROOT..."
    node "$SKILL_DIR/scripts/init-ships.mjs" || { echo "error: init failed"; exit 2; }
    echo "[tlon-run] done"
    exit 0
    ;;

  activity)
    sub="${1:-}"
    shift || true
    case "$sub" in
      mentions|replies|all|unreads) ;;
      *) echo "error: unknown activity subcommand '$sub'"; echo "usage: tlon-run activity {mentions|replies|all|unreads} [--limit N]"; exit 2 ;;
    esac

    if [ "${1:-}" = "--limit" ]; then
      limit="${2:-}"
      validate_limit "$limit" 25
      exec "$TS_NODE" "$SKILL_DIR/scripts/activity.ts" "$sub" --limit "$limit"
    else
      exec "$TS_NODE" "$SKILL_DIR/scripts/activity.ts" "$sub"
    fi
    ;;

  channels)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dms|group-dms|groups|all) ;;
      *) echo "error: unknown channels subcommand '$sub'"; echo "usage: tlon-run channels {dms|group-dms|groups|all}"; exit 2 ;;
    esac
    exec "$TS_NODE" "$SKILL_DIR/scripts/channels.ts" "$sub"
    ;;

  contacts)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec "$TS_NODE" "$SKILL_DIR/scripts/contacts.ts" list
        ;;
      self)
        exec "$TS_NODE" "$SKILL_DIR/scripts/contacts.ts" self
        ;;
      get)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship name"; echo "usage: tlon-run contacts get ~ship-name"; exit 2; }
        validate_ship "$who"
        exec "$TS_NODE" "$SKILL_DIR/scripts/contacts.ts" get "$who"
        ;;
      *)
        echo "error: unknown contacts subcommand '$sub'"
        echo "usage: tlon-run contacts {list|self|get ~ship}"
        exit 2
        ;;
    esac
    ;;

  groups)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec "$TS_NODE" "$SKILL_DIR/scripts/groups.ts" list
        ;;
      info)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups info ~host-ship/group-slug"; exit 2; }
        validate_group "$grp"
        exec "$TS_NODE" "$SKILL_DIR/scripts/groups.ts" info "$grp"
        ;;
      *)
        echo "error: unknown groups subcommand '$sub'"
        echo "usage: tlon-run groups {list|info ~host/slug}"
        exit 2
        ;;
    esac
    ;;

  messages)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dm)
        ship="${1:-}"
        [ -n "$ship" ] || { echo "error: missing ship"; echo "usage: tlon-run messages dm ~ship [--limit N]"; exit 2; }
        validate_ship "$ship"
        shift

        if [ "${1:-}" = "--limit" ]; then
          limit="${2:-}"
          validate_limit "$limit" 50
          exec "$TS_NODE" "$SKILL_DIR/scripts/messages.ts" dm "$ship" --limit "$limit"
        else
          exec "$TS_NODE" "$SKILL_DIR/scripts/messages.ts" dm "$ship"
        fi
        ;;
      channel|history)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run messages channel chat/~host/slug [--limit N]"; exit 2; }
        validate_channel "$chan"
        shift

        if [ "${1:-}" = "--limit" ]; then
          limit="${2:-}"
          validate_limit "$limit" 50
          exec "$TS_NODE" "$SKILL_DIR/scripts/messages.ts" "$sub" "$chan" --limit "$limit"
        else
          exec "$TS_NODE" "$SKILL_DIR/scripts/messages.ts" "$sub" "$chan"
        fi
        ;;
      *)
        echo "error: unknown messages subcommand '$sub'"
        echo "usage: tlon-run messages {dm ~ship|channel chat/~host/slug|history chat/~host/slug} [--limit N]"
        exit 2
        ;;
    esac
    ;;

  help|--help|-h)
    cat <<'EOF'
tlon-run: Safe Tlon API wrapper (read-only)

Usage: tlon-run [--ship ~name] <command> [args...]

Commands:
  init                                         - Generate ship configs from /pier
  activity {mentions|replies|all} [--limit N]  - Get activity feed (N <= 25)
  activity unreads                             - Get unread counts
  channels {dms|group-dms|groups|all}          - List channels
  contacts list                                - List all contacts
  contacts self                                - Get your profile
  contacts get ~ship                           - Get a contact's profile
  groups list                                  - List your groups
  groups info ~host/slug                       - Get group details
  messages dm ~ship [--limit N]                - Get DM history (N <= 50)
  messages channel chat/~host/slug [--limit N] - Get channel history (N <= 50)
  messages history chat/~host/slug [--limit N] - Same as channel

Ship Config:
  Configs are auto-generated from /pier on first run.
  Manual init: tlon-run init

  Files stored in: <skill-dir>/ships/<ship-name>.json
  Format: {"url": "http://127.0.0.1:8080", "ship": "~ship-name", "code": "xxxx-xxxx-xxxx-xxxx"}

  Specify ship via --ship flag or TLON_SHIP env var (auto-detected if only one ship).

Environment:
  TLON_SKILL_DIR  Override skill directory (default: /usr/local/share/moltbot/skills/tlon)
  TLON_SHIP       Default ship name (without ~)
  PIER_ROOT       Pier directory for auto-init (default: /pier)
EOF
    exit 0
    ;;

  "")
    echo "error: no command specified"
    echo "usage: tlon-run {init|activity|channels|contacts|groups|messages|help}"
    exit 2
    ;;

  *)
    echo "error: unknown command '$cmd'"
    echo "usage: tlon-run {init|activity|channels|contacts|groups|messages|help}"
    exit 2
    ;;
esac
