#!/usr/bin/env bash
set -euo pipefail

# tlon-run: Safe wrapper for Tlon skill scripts
# Designed for use by LLM agents without exec privileges
# Ship configs are generated by sidecar-init.mjs at container startup

SKILL_DIR="${TLON_SKILL_DIR:-/usr/local/share/moltbot/skills/tlon}"
DIST_DIR="$SKILL_DIR/dist"

# Handle help early (before other checks)
case "${1:-}" in
  help|--help|-h)
    cat <<'EOF'
tlon-run: Safe Tlon API wrapper

Usage: tlon-run [--ship ~name] <command> [args...]

Commands:
  activity {mentions|replies|all} [--limit N]  - Get activity feed
  activity unreads                             - Get unread counts
  channels {dms|group-dms|groups|all}          - List channels
  channels {info|update|delete} <nest>         - Manage channels
  contacts {list|self|get|sync|add|remove}     - Manage contacts
  contacts update-profile --nickname "..."     - Update your profile
  groups {list|info|create|join|delete|update} - Group basics
  groups {invite|leave|kick|ban|unban}         - Group membership
  groups {add-role|delete-role|update-role}     - Group roles
  groups {assign-role|remove-role}             - Role assignment
  groups {set-privacy|accept-join|reject-join} - Group access
  groups add-channel ~host/slug "Name" [opts]  - Add channel to group
  messages {dm|channel|history} [--limit N]    - Read messages
  messages search "query" --channel <nest>     - Search messages
  dms {send|reply|react|unreact|delete}        - DM operations
  dms {accept|decline}                         - DM invites
  posts {send|reply|react|unreact|delete}      - Channel posts
  notebook <nest> "Title" [--content file]     - Post to notebook/diary
  settings {get|set|delete}                    - Bot settings
  settings {allow-dm|remove-dm}               - DM allowlist
  settings {allow-channel|remove-channel}      - Channel watch list
  settings {open-channel|restrict-channel}     - Channel access
  settings {authorize-ship|deauthorize-ship}   - Default auth
  soul {read|replace|append} [content]          - Edit SOUL.md
  user {read|replace|append} [content]          - Edit USER.md
  tools {read|replace|append} [content]         - Edit TOOLS.md
  agents {read|replace|append} [content]        - Edit AGENTS.md
  bootstrap {read|replace|append} [content]     - Edit BOOTSTRAP.md
  heartbeat {read|replace|append} [content]     - Edit HEARTBEAT.md
  identity {read|replace|append} [content]      - Edit IDENTITY.md
  memory {read|replace|append} [content]        - Edit MEMORY.md
  click <operation> [args...]                  - Ship operations via click

Ship Selection:
  Configs are generated by sidecar-init at container startup.
  Files stored in: <skill-dir>/ships/<ship-name>.json

  Auto-detected if only one ship is configured.
  With multiple ships, --ship is required and must come BEFORE the command:
    tlon-run --ship ~sampel-palnet groups list

Environment:
  TLON_SKILL_DIR  Override skill directory (default: /usr/local/share/moltbot/skills/tlon)
  TLON_SHIP       Default ship name (without ~)
EOF
    exit 0
    ;;
esac

# Handle --ship flag (must be first argument, before any command)
if [ "${1:-}" = "--ship" ]; then
  TLON_SHIP="${2:-}"
  [ -n "$TLON_SHIP" ] || { echo "error: --ship requires a ship name"; exit 2; }
  shift 2
fi

# Workspace file commands (no ship/dist needed)
resolve_workspace_file() {
  local name="$1"
  [[ "$name" =~ ^[A-Za-z][A-Za-z0-9_-]*$ ]] || { echo "error: invalid file name '$name'" >&2; exit 2; }
  [ -n "${WORKSPACE_DIR:-}" ] || { echo "error: WORKSPACE_DIR not set" >&2; exit 2; }
  [ -d "$WORKSPACE_DIR" ] || { echo "error: workspace not found: $WORKSPACE_DIR" >&2; exit 2; }
  echo "$WORKSPACE_DIR/${name}.md"
}

case "${1:-}" in
  soul|user|tools|agents|bootstrap|heartbeat|identity|memory)
    cmd="$1"
    shift
    file_name="$(echo "$cmd" | tr '[:lower:]' '[:upper:]')"
    target="$(resolve_workspace_file "$file_name")"
    sub="${1:-}"
    shift || true
    case "$sub" in
      read)
        [ -f "$target" ] && cat "$target" || echo "(empty)"
        ;;
      replace)
        content="${1:-}"
        [ -n "$content" ] || { echo "error: missing content"; exit 2; }
        printf '%s\n' "$content" > "$target"
        echo "ok: replaced ${file_name}.md"
        ;;
      append)
        content="${1:-}"
        [ -n "$content" ] || { echo "error: missing content"; exit 2; }
        printf '\n%s\n' "$content" >> "$target"
        echo "ok: appended to ${file_name}.md"
        ;;
      *)
        echo "error: unknown subcommand '$sub'"
        echo "usage: tlon-run $cmd {read|replace|append} [content]"
        exit 2
        ;;
    esac
    exit 0
    ;;
esac

# Hard fail if dist isn't present (need to run npm run build)
[ -d "$DIST_DIR" ] || { echo "error: tlon-skill not built at $SKILL_DIR (run npm run build)"; exit 2; }

# Export skill dir for scripts
export TLON_SKILL_DIR="$SKILL_DIR"

# If no TLON_SHIP specified, try to auto-detect from available configs
if [ -z "${TLON_SHIP:-}" ]; then
  ships_dir="$SKILL_DIR/ships"
  ship_configs=()
  if [ -d "$ships_dir" ]; then
    for f in "$ships_dir"/*.json; do
      [ -f "$f" ] || continue
      [ "$(basename "$f")" = "example.json" ] && continue
      ship_configs+=("$(basename "$f" .json)")
    done
  fi

  if [ ${#ship_configs[@]} -eq 0 ]; then
    echo "error: no ship config found in $SKILL_DIR/ships/"
    echo "Ship configs are generated by sidecar-init at container startup."
    exit 2
  elif [ ${#ship_configs[@]} -eq 1 ]; then
    TLON_SHIP="${ship_configs[0]}"
  else
    echo "error: multiple ships configured, specify one with --ship"
    for s in "${ship_configs[@]}"; do echo "  ~$s"; done
    exit 2
  fi
fi

SHIP_FILE="$SKILL_DIR/ships/${TLON_SHIP#\~}.json"
[ -f "$SHIP_FILE" ] || { echo "error: ship config not found: $SHIP_FILE"; exit 2; }
export TLON_SHIP="${TLON_SHIP#\~}"

# Validation helpers
validate_ship() {
  local ship="$1"
  # Urbit ship names: ~prefix or ~prefix-suffix-... (1-4 syllable parts)
  [[ "$ship" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}$ ]] || { echo "error: invalid ship name '$ship'"; exit 2; }
}

validate_group() {
  local grp="$1"
  # Group format: ~host-ship/slug (slug is alphanumeric with hyphens)
  [[ "$grp" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid group '$grp'"; exit 2; }
}

validate_channel() {
  local chan="$1"
  # Channel format: type/~host/slug where type is chat|diary|heap
  [[ "$chan" =~ ^(chat|diary|heap)/~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid channel '$chan'"; exit 2; }
}

validate_limit() {
  local limit="$1"
  local max="${2:-25}"
  [[ "$limit" =~ ^[0-9]+$ ]] || { echo "error: limit must be a number"; exit 2; }
  [ "$limit" -ge 1 ] || { echo "error: limit must be at least 1"; exit 2; }
  [ "$limit" -le "$max" ] || { echo "error: limit cannot exceed $max"; exit 2; }
}

# Click helpers

# Desk names: %letters-and-hyphens
validate_desk() {
  local desk="$1"
  [[ "$desk" =~ ^[a-z][a-z0-9-]*$ ]] || { echo "error: invalid desk name '$desk'"; exit 2; }
}

# Agent names: same format as desk names
validate_agent() {
  local agent="$1"
  [[ "$agent" =~ ^[a-z][a-z0-9-]*$ ]] || { echo "error: invalid agent name '$agent'"; exit 2; }
}

# Group flag format: ~host-ship/group-name â†’ [~host-ship %group-name]
format_as_cell() {
  local flag="$1"
  local ship="${flag%%/*}"
  local name="${flag#*/}"
  echo "[${ship} %${name}]"
}

# Read pierPath from ship JSON config
get_pier_path() {
  local pier
  pier="$(node -e "process.stdout.write(JSON.parse(require('fs').readFileSync('$SHIP_FILE','utf8')).pierPath||'')")"
  [ -n "$pier" ] || { echo "error: no pierPath in ship config $SHIP_FILE"; exit 2; }
  echo "$pier"
}

# Execute a click command against the ship's pier
run_click() {
  local pier="$1"
  local hoon="$2"
  [ -d "$pier" ] || { echo "error: pier not found at $pier"; exit 2; }
  exec click -k "$pier" "$hoon"
}

# Get command
cmd="${1:-}"
shift || true

case "$cmd" in
  activity)
    sub="${1:-}"
    shift || true
    case "$sub" in
      mentions|replies|all|unreads) ;;
      *) echo "error: unknown activity subcommand '$sub'"; echo "usage: tlon-run activity {mentions|replies|all|unreads} [--limit N]"; exit 2 ;;
    esac

    if [ "${1:-}" = "--limit" ]; then
      limit="${2:-}"
      validate_limit "$limit" 25
      exec node "$DIST_DIR/activity.js" "$sub" --limit "$limit"
    else
      exec node "$DIST_DIR/activity.js" "$sub"
    fi
    ;;

  channels)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dms|group-dms|groups|all)
        exec node "$DIST_DIR/channels.js" "$sub"
        ;;
      info)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel nest"; echo "usage: tlon-run channels info chat/~host/slug"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/channels.js" info "$chan"
        ;;
      update)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel nest"; echo "usage: tlon-run channels update chat/~host/slug --title \"...\" [--description \"...\"]"; exit 2; }
        validate_channel "$chan"
        shift
        exec node "$DIST_DIR/channels.js" update "$chan" "$@"
        ;;
      delete)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel nest"; echo "usage: tlon-run channels delete chat/~host/slug"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/channels.js" delete "$chan"
        ;;
      *) echo "error: unknown channels subcommand '$sub'"; echo "usage: tlon-run channels {dms|group-dms|groups|all|info|update|delete}"; exit 2 ;;
    esac
    ;;

  contacts)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec node "$DIST_DIR/contacts.js" list
        ;;
      self)
        exec node "$DIST_DIR/contacts.js" self
        ;;
      get)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship name"; echo "usage: tlon-run contacts get ~ship-name"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/contacts.js" get "$who"
        ;;
      sync)
        [ $# -ge 1 ] || { echo "error: missing ship(s)"; echo "usage: tlon-run contacts sync ~ship1 ~ship2 ..."; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/contacts.js" sync "$@"
        ;;
      add)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship name"; echo "usage: tlon-run contacts add ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/contacts.js" add "$who"
        ;;
      remove)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship name"; echo "usage: tlon-run contacts remove ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/contacts.js" remove "$who"
        ;;
      update-profile)
        [ $# -ge 1 ] || { echo "error: missing options"; echo "usage: tlon-run contacts update-profile --nickname \"...\" [--bio \"...\"] [--status \"...\"]"; exit 2; }
        exec node "$DIST_DIR/contacts.js" update-profile "$@"
        ;;
      *)
        echo "error: unknown contacts subcommand '$sub'"
        echo "usage: tlon-run contacts {list|self|get|sync|add|remove|update-profile}"
        exit 2
        ;;
    esac
    ;;

  groups)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec node "$DIST_DIR/groups.js" list
        ;;
      info)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups info ~host-ship/group-slug"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" info "$grp"
        ;;
      create)
        name="${1:-}"
        [ -n "$name" ] || { echo "error: missing group name"; echo "usage: tlon-run groups create \"Group Name\" [--description \"...\"]"; exit 2; }
        shift
        # Pass remaining args (--description) through
        exec node "$DIST_DIR/groups.js" create "$name" "$@"
        ;;
      invite)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups invite ~host-ship/slug ~ship1 ~ship2"; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing invitees"; exit 2; }
        for inv in "$@"; do validate_ship "$inv"; done
        exec node "$DIST_DIR/groups.js" invite "$grp" "$@"
        ;;
      leave)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups leave ~host-ship/slug"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" leave "$grp"
        ;;
      join)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups join ~host-ship/slug"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" join "$grp"
        ;;
      delete)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups delete ~host-ship/slug"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" delete "$grp"
        ;;
      update)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups update ~host-ship/slug --title \"...\" [--description \"...\"]"; exit 2; }
        validate_group "$grp"
        shift
        exec node "$DIST_DIR/groups.js" update "$grp" "$@"
        ;;
      kick)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups kick ~host-ship/slug ~ship1 ~ship2"; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing ship(s) to kick"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" kick "$grp" "$@"
        ;;
      ban)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups ban ~host-ship/slug ~ship1 ~ship2"; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing ship(s) to ban"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" ban "$grp" "$@"
        ;;
      unban)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups unban ~host-ship/slug ~ship1 ~ship2"; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing ship(s) to unban"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" unban "$grp" "$@"
        ;;
      add-role)
        grp="${1:-}"
        role="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups add-role ~host/slug <role-id> --title \"...\""; exit 2; }
        [ -n "$role" ] || { echo "error: missing role id"; exit 2; }
        validate_group "$grp"
        shift 2
        exec node "$DIST_DIR/groups.js" add-role "$grp" "$role" "$@"
        ;;
      delete-role)
        grp="${1:-}"
        role="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups delete-role ~host/slug <role-id>"; exit 2; }
        [ -n "$role" ] || { echo "error: missing role id"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" delete-role "$grp" "$role"
        ;;
      update-role)
        grp="${1:-}"
        role="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups update-role ~host/slug <role-id> --title \"...\""; exit 2; }
        [ -n "$role" ] || { echo "error: missing role id"; exit 2; }
        validate_group "$grp"
        shift 2
        exec node "$DIST_DIR/groups.js" update-role "$grp" "$role" "$@"
        ;;
      assign-role)
        grp="${1:-}"
        role="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups assign-role ~host/slug <role-id> ~ship1 ..."; exit 2; }
        [ -n "$role" ] || { echo "error: missing role id"; exit 2; }
        validate_group "$grp"
        shift 2
        [ $# -ge 1 ] || { echo "error: missing ship(s)"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" assign-role "$grp" "$role" "$@"
        ;;
      remove-role)
        grp="${1:-}"
        role="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups remove-role ~host/slug <role-id> ~ship1 ..."; exit 2; }
        [ -n "$role" ] || { echo "error: missing role id"; exit 2; }
        validate_group "$grp"
        shift 2
        [ $# -ge 1 ] || { echo "error: missing ship(s)"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" remove-role "$grp" "$role" "$@"
        ;;
      set-privacy)
        grp="${1:-}"
        privacy="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups set-privacy ~host/slug public|private|secret"; exit 2; }
        [ -n "$privacy" ] || { echo "error: missing privacy level"; exit 2; }
        validate_group "$grp"
        case "$privacy" in
          public|private|secret) ;;
          *) echo "error: privacy must be public, private, or secret"; exit 2 ;;
        esac
        exec node "$DIST_DIR/groups.js" set-privacy "$grp" "$privacy"
        ;;
      accept-join)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups accept-join ~host/slug ~ship1 ..."; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing ship(s)"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" accept-join "$grp" "$@"
        ;;
      reject-join)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups reject-join ~host/slug ~ship1 ..."; exit 2; }
        validate_group "$grp"
        shift
        [ $# -ge 1 ] || { echo "error: missing ship(s)"; exit 2; }
        for s in "$@"; do validate_ship "$s"; done
        exec node "$DIST_DIR/groups.js" reject-join "$grp" "$@"
        ;;
      add-channel)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups add-channel ~host-ship/slug \"Channel Name\" [--kind chat|diary|heap] [--description \"...\"]"; exit 2; }
        validate_group "$grp"
        shift
        title="${1:-}"
        [ -n "$title" ] || { echo "error: missing channel title"; exit 2; }
        shift
        # Pass remaining args (--kind, --description) through
        exec node "$DIST_DIR/groups.js" add-channel "$grp" "$title" "$@"
        ;;
      *)
        echo "error: unknown groups subcommand '$sub'"
        echo "usage: tlon-run groups {list|info|create|join|delete|update|invite|leave|kick|ban|unban|add-channel|add-role|delete-role|update-role|assign-role|remove-role|set-privacy|accept-join|reject-join}"
        exit 2
        ;;
    esac
    ;;

  messages)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dm)
        ship="${1:-}"
        [ -n "$ship" ] || { echo "error: missing ship"; echo "usage: tlon-run messages dm ~ship [--limit N] [--resolve-cites]"; exit 2; }
        validate_ship "$ship"
        shift
        exec node "$DIST_DIR/messages.js" dm "$ship" "$@"
        ;;
      channel|history)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run messages channel chat/~host/slug [--limit N] [--resolve-cites]"; exit 2; }
        validate_channel "$chan"
        shift
        exec node "$DIST_DIR/messages.js" "$sub" "$chan" "$@"
        ;;
      search)
        query="${1:-}"
        [ -n "$query" ] || { echo "error: missing search query"; echo "usage: tlon-run messages search \"query\" --channel chat/~host/slug"; exit 2; }
        shift
        exec node "$DIST_DIR/messages.js" search "$query" "$@"
        ;;
      *)
        echo "error: unknown messages subcommand '$sub'"
        echo "usage: tlon-run messages {dm|channel|history|search} [args...]"
        exit 2
        ;;
    esac
    ;;

  dms)
    sub="${1:-}"
    shift || true
    case "$sub" in
      send)
        target="${1:-}"
        msg="${2:-}"
        [ -n "$target" ] || { echo "error: missing target"; echo "usage: tlon-run dms send ~ship|<club-id> \"message\""; exit 2; }
        [ -n "$msg" ] || { echo "error: missing message"; exit 2; }
        exec node "$DIST_DIR/dms.js" send "$target" "$msg"
        ;;
      reply)
        target="${1:-}"
        post_id="${2:-}"
        msg="${3:-}"
        [ -n "$target" ] || { echo "error: missing target"; echo "usage: tlon-run dms reply ~ship <post-id> \"message\""; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        [ -n "$msg" ] || { echo "error: missing message"; exit 2; }
        exec node "$DIST_DIR/dms.js" reply "$target" "$post_id" "$msg"
        ;;
      react)
        target="${1:-}"
        post_id="${2:-}"
        emoji="${3:-}"
        [ -n "$target" ] || { echo "error: missing target"; echo "usage: tlon-run dms react ~ship <post-id> <emoji>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        [ -n "$emoji" ] || { echo "error: missing emoji"; exit 2; }
        exec node "$DIST_DIR/dms.js" react "$target" "$post_id" "$emoji"
        ;;
      unreact)
        target="${1:-}"
        post_id="${2:-}"
        [ -n "$target" ] || { echo "error: missing target"; echo "usage: tlon-run dms unreact ~ship <post-id>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        exec node "$DIST_DIR/dms.js" unreact "$target" "$post_id"
        ;;
      delete)
        target="${1:-}"
        post_id="${2:-}"
        [ -n "$target" ] || { echo "error: missing target"; echo "usage: tlon-run dms delete ~ship <post-id>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        exec node "$DIST_DIR/dms.js" delete "$target" "$post_id"
        ;;
      accept)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run dms accept ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/dms.js" accept "$who"
        ;;
      decline)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run dms decline ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/dms.js" decline "$who"
        ;;
      *)
        echo "error: unknown dms subcommand '$sub'"
        echo "usage: tlon-run dms {send|reply|react|unreact|delete|accept|decline}"
        exit 2
        ;;
    esac
    ;;

  posts)
    sub="${1:-}"
    shift || true
    case "$sub" in
      send)
        chan="${1:-}"
        msg="${2:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run posts send chat/~host/slug \"message\""; exit 2; }
        [ -n "$msg" ] || { echo "error: missing message"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/posts.js" send "$chan" "$msg"
        ;;
      reply)
        chan="${1:-}"
        post_id="${2:-}"
        msg="${3:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run posts reply chat/~host/slug <post-id> \"message\""; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        [ -n "$msg" ] || { echo "error: missing message"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/posts.js" reply "$chan" "$post_id" "$msg"
        ;;
      react)
        chan="${1:-}"
        post_id="${2:-}"
        emoji="${3:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run posts react chat/~host/slug <post-id> <emoji>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        [ -n "$emoji" ] || { echo "error: missing emoji"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/posts.js" react "$chan" "$post_id" "$emoji"
        ;;
      unreact)
        chan="${1:-}"
        post_id="${2:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run posts unreact chat/~host/slug <post-id>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/posts.js" unreact "$chan" "$post_id"
        ;;
      delete)
        chan="${1:-}"
        post_id="${2:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run posts delete chat/~host/slug <post-id>"; exit 2; }
        [ -n "$post_id" ] || { echo "error: missing post id"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/posts.js" delete "$chan" "$post_id"
        ;;
      *)
        echo "error: unknown posts subcommand '$sub'"
        echo "usage: tlon-run posts {send|reply|react|unreact|delete}"
        exit 2
        ;;
    esac
    ;;

  notebook)
    nest="${1:-}"
    title="${2:-}"
    [ -n "$nest" ] || { echo "error: missing notebook nest"; echo "usage: tlon-run notebook diary/~host/slug \"Title\" [--content file] [--stdin]"; exit 2; }
    [ -n "$title" ] || { echo "error: missing title"; exit 2; }
    validate_channel "$nest"
    shift 2
    exec node "$DIST_DIR/notebook-post.js" "$nest" "$title" "$@"
    ;;

  settings)
    sub="${1:-}"
    shift || true
    case "$sub" in
      get)
        exec node "$DIST_DIR/settings.js" get
        ;;
      set)
        key="${1:-}"
        val="${2:-}"
        [ -n "$key" ] || { echo "error: missing key"; echo "usage: tlon-run settings set <key> <json-value>"; exit 2; }
        [ -n "$val" ] || { echo "error: missing value"; exit 2; }
        exec node "$DIST_DIR/settings.js" set "$key" "$val"
        ;;
      delete|del)
        key="${1:-}"
        [ -n "$key" ] || { echo "error: missing key"; echo "usage: tlon-run settings delete <key>"; exit 2; }
        exec node "$DIST_DIR/settings.js" delete "$key"
        ;;
      allow-dm|add-dm)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run settings allow-dm ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/settings.js" allow-dm "$who"
        ;;
      remove-dm)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run settings remove-dm ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/settings.js" remove-dm "$who"
        ;;
      allow-channel|add-channel)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run settings allow-channel chat/~host/slug"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/settings.js" allow-channel "$chan"
        ;;
      remove-channel)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run settings remove-channel chat/~host/slug"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/settings.js" remove-channel "$chan"
        ;;
      open-channel)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run settings open-channel chat/~host/slug"; exit 2; }
        validate_channel "$chan"
        exec node "$DIST_DIR/settings.js" open-channel "$chan"
        ;;
      restrict-channel)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run settings restrict-channel chat/~host/slug [~ship1 ...]"; exit 2; }
        validate_channel "$chan"
        shift
        exec node "$DIST_DIR/settings.js" restrict-channel "$chan" "$@"
        ;;
      set-rule)
        chan="${1:-}"
        mode="${2:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run settings set-rule chat/~host/slug open|restricted [~ship1 ...]"; exit 2; }
        [ -n "$mode" ] || { echo "error: missing mode (open or restricted)"; exit 2; }
        validate_channel "$chan"
        case "$mode" in
          open|restricted) ;;
          *) echo "error: mode must be open or restricted"; exit 2 ;;
        esac
        shift 2
        exec node "$DIST_DIR/settings.js" set-rule "$chan" "$mode" "$@"
        ;;
      authorize-ship|add-auth)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run settings authorize-ship ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/settings.js" authorize-ship "$who"
        ;;
      deauthorize-ship|remove-auth)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship"; echo "usage: tlon-run settings deauthorize-ship ~ship"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/settings.js" deauthorize-ship "$who"
        ;;
      *)
        echo "error: unknown settings subcommand '$sub'"
        echo "usage: tlon-run settings {get|set|delete|allow-dm|remove-dm|allow-channel|remove-channel|open-channel|restrict-channel|set-rule|authorize-ship|deauthorize-ship}"
        exit 2
        ;;
    esac
    ;;

  click)
    op="${1:-}"
    shift || true
    pier="$(get_pier_path)"

    case "$op" in
      # --- System ---
      get-code)
        run_click "$pier" $'=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  code=@p  bind:m  (scry @p /j/code/(scot %p our))  (pure:m !>((crip (slag 1 (scow %p code)))))'
        ;;
      get-vats)
        run_click "$pier" $'=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  now=@da  bind:m  get-time  (pure:m !>((report-vats our now [%kids ~] %exists &)))'
        ;;
      bump)
        run_click "$pier" $'=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-bump !>(~))  (pure:m !>(~))'
        ;;
      ota)
        local_desk="${1:-}"
        remote_desk="${2:-}"
        source="${3:-}"
        [ -n "$local_desk" ] || { echo "error: missing local desk"; echo "usage: tlon-run click ota <local-desk> <remote-desk> ~source-ship"; exit 2; }
        [ -n "$remote_desk" ] || { echo "error: missing remote desk"; echo "usage: tlon-run click ota <local-desk> <remote-desk> ~source-ship"; exit 2; }
        [ -n "$source" ] || { echo "error: missing source ship"; echo "usage: tlon-run click ota <local-desk> <remote-desk> ~source-ship"; exit 2; }
        validate_desk "$local_desk"
        validate_desk "$remote_desk"
        validate_ship "$source"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  ~  bind:m  (poke [our %hood] %kiln-install !>([%${local_desk} ${source} %${remote_desk}]))  (pure:m !>(\\\'success\\\'))"
        ;;
      commit)
        desk="${1:-}"
        [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click commit <desk>"; exit 2; }
        validate_desk "$desk"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-commit !>([[%${desk}] %.n]))  (pure:m !>(~))"
        ;;
      mount)
        desk="${1:-}"
        [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click mount <desk>"; exit 2; }
        validate_desk "$desk"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  now=@da  bind:m  get-time  ;<  ~  bind:m  (poke-our %hood %kiln-mount !>([(en-beam [our %${desk} [%da now]] /) %${desk}]))  (pure:m !>(~))"
        ;;
      unmount)
        desk="${1:-}"
        [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click unmount <desk>"; exit 2; }
        validate_desk "$desk"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-unmount !>(%${desk}))  (pure:m !>(~))"
        ;;
      revive)
        desk="${1:-}"
        [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click revive <desk>"; exit 2; }
        validate_desk "$desk"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  ~  bind:m  (poke [our %hood] %kiln-revive !>(${desk}))  (pure:m !>(~))"
        ;;
      merge-remote)
        source="${1:-}"
        src_desk="${2:-}"
        dst_desk="${3:-}"
        [ -n "$source" ] || { echo "error: missing source ship"; echo "usage: tlon-run click merge-remote ~source-ship <src-desk> <dst-desk>"; exit 2; }
        [ -n "$src_desk" ] || { echo "error: missing source desk"; exit 2; }
        [ -n "$dst_desk" ] || { echo "error: missing destination desk"; exit 2; }
        validate_ship "$source"
        validate_desk "$src_desk"
        validate_desk "$dst_desk"
        run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ~&  \\\'Merging ${source}/${src_desk} into ${dst_desk}\\\'  =/  src-ship  ${source}  =/  src-desk  ${src_desk}  =/  dst-desk  ${dst_desk}  ;<  now=@da  bind:m  get-time  =/  kiln-merge  [dst-desk src-ship src-desk [%da now] %only-that]  ;<  ~  bind:m  (poke-our %hood %kiln-merge !>(kiln-merge))  (pure:m !>(~))"
        ;;
      merge-to-kids)
        run_click "$pier" $'=/  m  (strand ,vase)  ^-  form:m  ;<  our=@p  bind:m  get-our  =/  src-desk  %base  =/  dst-desk  %kids  ;<  now=@da  bind:m  get-time  =/  kiln-merge  [dst-desk our src-desk [%da now] %only-that]  ;<  ~  bind:m  (poke-our %hood %kiln-merge !>(kiln-merge))  (pure:m !>(~))'
        ;;
      is-agent-running)
        agent="${1:-}"
        [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click is-agent-running <agent>"; exit 2; }
        validate_agent "$agent"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  a=?  bind:m  (scry ? /gu/${agent}/\$)  (pure:m !>(a))"
        ;;
      moon-key)
        moon="${1:-}"
        [ -n "$moon" ] || { echo "error: missing moon prefix"; echo "usage: tlon-run click moon-key <moon-prefix>"; exit 2; }
        # moon prefix is just a syllable like "doznec"
        [[ "$moon" =~ ^[a-z]{6}$ ]] || { echo "error: invalid moon prefix '$moon' (expected 6 lowercase letters)"; exit 2; }
        # The planet name is read from the ship config to construct the full moon name
        planet="$(node -e "process.stdout.write(JSON.parse(require('fs').readFileSync('$SHIP_FILE','utf8')).ship||'')")"
        [ -n "$planet" ] || { echo "error: no ship name in config $SHIP_FILE"; exit 2; }
        run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ;<  bowl=bowl:spider  bind:m  get-bowl  =/  mon=ship  ~${moon}-${planet#\~}  =/  cub  (pit:nu:crub:crypto 512 (shaz (jam mon life=1 eny.bowl)))  =/  =feed:jael  [[%2 ~] mon rift=0 [life=1 sec:ex:cub]~]  =/  =pass  pub:ex:cub  =/  udif=udiff:point:jael  [*id:block:jael %keys [1 1 pass] %.n]  ;<  ~  bind:m  (poke [our.bowl %hood] %helm-moon !>(\`[mon udif]))  (pure:m !>((crip (scow %uw (jam feed)))))"
        ;;
      get-remote-hash)
        source="${1:-}"
        desk="${2:-}"
        [ -n "$source" ] || { echo "error: missing source ship"; echo "usage: tlon-run click get-remote-hash ~source-ship <desk>"; exit 2; }
        [ -n "$desk" ] || { echo "error: missing desk name"; exit 2; }
        validate_ship "$source"
        validate_desk "$desk"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  now=@da  bind:m  get-time  ;<  r=riot:clay  bind:m  (warp ${source} %${desk} ~ %sing %z da+now /)  ?~(r (pure:m !>(~)) (pure:m q.r.u.r))"
        ;;
      dump-agent-eggs)
        agent="${1:-}"
        [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click dump-agent-eggs <agent>"; exit 2; }
        validate_agent "$agent"
        run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  a=egg-any:gall  bind:m  (scry egg-any:gall /gv/${agent}/\$)  ;<  ~  bind:m  (poke [our %hood] %drum-put !>([/${agent}/jam (jam ?>(?=(%live +<.a) a(p.old-state -:!>(**))))]))  (pure:m !>(~))"
        ;;
      load-agent-eggs)
        agent="${1:-}"
        [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click load-agent-eggs <agent>"; exit 2; }
        validate_agent "$agent"
        run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ;<  egg=@  bind:m  (scry @ /cx/base/bak/${agent}/jam)  ;<  our=@p  bind:m  get-our  =/  dk=dock  [our %${agent}]  =/  cg=cage  [%noun !>((cue egg))]  =/  =card:agent:gall  [%pass /pokeas %agent dk %poke %egg-any -:!>(*egg-any:gall) (cue egg)]  ;<  ~  bind:m  (send-raw-card card)  ;<  ~  bind:m  (take-poke-ack /pokeas)  (pure:m !>(~))"
        ;;

      # --- Groups ---
      force-join)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group flag"; echo "usage: tlon-run click force-join ~host/group-name"; exit 2; }
        validate_group "$grp"
        flag="$(format_as_cell "$grp")"
        run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  =/  flag  ${flag}  ;<  ~  bind:m  (poke-our %groups %group-foreign-1 !>([%foreign flag [%join ~]]))  (pure:m !>(~))"
        ;;
      force-join-token)
        grp="${1:-}"
        token="${2:-}"
        [ -n "$grp" ] || { echo "error: missing group flag"; echo "usage: tlon-run click force-join-token ~host/group-name <token>"; exit 2; }
        [ -n "$token" ] || { echo "error: missing token"; exit 2; }
        validate_group "$grp"
        flag="$(format_as_cell "$grp")"
        run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  =/  flag  ${flag}  ;<  ~  bind:m  (poke-our %groups %group-foreign-1 !>([%foreign flag [%join (some ${token})]]))  (pure:m !>(~))"
        ;;

      # --- Raw Hoon ---
      eval)
        hoon="${1:-}"
        [ -n "$hoon" ] || { echo "error: missing hoon thread"; echo "usage: tlon-run click eval '<hoon thread string>'"; exit 2; }
        run_click "$pier" "$hoon"
        ;;

      "")
        echo "error: no click operation specified"
        echo "usage: tlon-run click <operation> [args...]"
        echo ""
        echo "System: get-code, get-vats, bump, ota, commit, mount, unmount,"
        echo "  revive, merge-remote, merge-to-kids, is-agent-running, moon-key,"
        echo "  get-remote-hash, dump-agent-eggs, load-agent-eggs"
        echo "Groups: force-join, force-join-token"
        echo "Raw: eval '<hoon thread>'"
        exit 2
        ;;
      *)
        echo "error: unknown click operation '$op'"
        echo "usage: tlon-run click <operation> [args...]"
        exit 2
        ;;
    esac
    ;;

  "")
    echo "error: no command specified"
    echo "usage: tlon-run {activity|channels|contacts|groups|messages|dms|posts|notebook|settings|soul|user|tools|agents|bootstrap|heartbeat|identity|memory|click|help}"
    exit 2
    ;;

  *)
    echo "error: unknown command '$cmd'"
    echo "usage: tlon-run {activity|channels|contacts|groups|messages|dms|posts|notebook|settings|soul|user|tools|agents|bootstrap|heartbeat|identity|memory|click|help}"
    exit 2
    ;;
esac
