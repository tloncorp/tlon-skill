#!/usr/bin/env bash
set -euo pipefail

# tlon-run: Safe wrapper for Tlon skill scripts
# Designed for use by LLM agents without exec privileges
# Ship configs are generated by sidecar-init.mjs at container startup

SKILL_DIR="${TLON_SKILL_DIR:-/usr/local/share/moltbot/skills/tlon}"
DIST_DIR="$SKILL_DIR/dist"

# Handle help early (before other checks)
case "${1:-}" in
  help|--help|-h)
    cat <<'EOF'
tlon-run: Safe Tlon API wrapper

Usage: tlon-run [--ship ~name] <command> [args...]

Commands:
  activity {mentions|replies|all} [--limit N]  - Get activity feed (N <= 25)
  activity unreads                             - Get unread counts
  channels {dms|group-dms|groups|all}          - List channels
  contacts list                                - List all contacts
  contacts self                                - Get your profile
  contacts get ~ship                           - Get a contact's profile
  groups list                                  - List your groups
  groups info ~host/slug                       - Get group details
  messages dm ~ship [--limit N]                - Get DM history (N <= 50)
  messages channel chat/~host/slug [--limit N] - Get channel history (N <= 50)
  messages history chat/~host/slug [--limit N] - Same as channel

Ship Config:
  Configs are generated by sidecar-init at container startup.
  Files stored in: <skill-dir>/ships/<ship-name>.json

  Specify ship via --ship flag or TLON_SHIP env var (auto-detected if only one ship).

Environment:
  TLON_SKILL_DIR  Override skill directory (default: /usr/local/share/moltbot/skills/tlon)
  TLON_SHIP       Default ship name (without ~)
EOF
    exit 0
    ;;
esac

# Hard fail if dist isn't present (need to run npm run build)
[ -d "$DIST_DIR" ] || { echo "error: tlon-skill not built at $SKILL_DIR (run npm run build)"; exit 2; }

# Export skill dir for scripts
export TLON_SKILL_DIR="$SKILL_DIR"

# Handle --ship flag (must be first argument)
if [ "${1:-}" = "--ship" ]; then
  TLON_SHIP="${2:-}"
  [ -n "$TLON_SHIP" ] || { echo "error: --ship requires a ship name"; exit 2; }
  shift 2
fi

# If no TLON_SHIP specified, try to auto-detect from available configs
if [ -z "${TLON_SHIP:-}" ]; then
  ships_dir="$SKILL_DIR/ships"
  if [ -d "$ships_dir" ]; then
    # Find first non-example config
    for f in "$ships_dir"/*.json; do
      [ -f "$f" ] || continue
      [ "$(basename "$f")" = "example.json" ] && continue
      # Extract ship name from filename
      TLON_SHIP="$(basename "$f" .json)"
      break
    done
  fi
fi

# Validate ship config exists
if [ -z "${TLON_SHIP:-}" ]; then
  echo "error: no ship config found in $SKILL_DIR/ships/"
  echo "Ship configs are generated by sidecar-init at container startup."
  exit 2
fi

SHIP_FILE="$SKILL_DIR/ships/${TLON_SHIP#\~}.json"
[ -f "$SHIP_FILE" ] || { echo "error: ship config not found: $SHIP_FILE"; exit 2; }
export TLON_SHIP="${TLON_SHIP#\~}"

# Validation helpers
validate_ship() {
  local ship="$1"
  # Urbit ship names: ~prefix or ~prefix-suffix-... (1-4 syllable parts)
  [[ "$ship" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}$ ]] || { echo "error: invalid ship name '$ship'"; exit 2; }
}

validate_group() {
  local grp="$1"
  # Group format: ~host-ship/slug (slug is alphanumeric with hyphens)
  [[ "$grp" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid group '$grp'"; exit 2; }
}

validate_channel() {
  local chan="$1"
  # Channel format: type/~host/slug where type is chat|diary|heap
  [[ "$chan" =~ ^(chat|diary|heap)/~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid channel '$chan'"; exit 2; }
}

validate_limit() {
  local limit="$1"
  local max="${2:-25}"
  [[ "$limit" =~ ^[0-9]+$ ]] || { echo "error: limit must be a number"; exit 2; }
  [ "$limit" -ge 1 ] || { echo "error: limit must be at least 1"; exit 2; }
  [ "$limit" -le "$max" ] || { echo "error: limit cannot exceed $max"; exit 2; }
}

# Get command
cmd="${1:-}"
shift || true

case "$cmd" in
  activity)
    sub="${1:-}"
    shift || true
    case "$sub" in
      mentions|replies|all|unreads) ;;
      *) echo "error: unknown activity subcommand '$sub'"; echo "usage: tlon-run activity {mentions|replies|all|unreads} [--limit N]"; exit 2 ;;
    esac

    if [ "${1:-}" = "--limit" ]; then
      limit="${2:-}"
      validate_limit "$limit" 25
      exec node "$DIST_DIR/activity.js" "$sub" --limit "$limit"
    else
      exec node "$DIST_DIR/activity.js" "$sub"
    fi
    ;;

  channels)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dms|group-dms|groups|all) ;;
      *) echo "error: unknown channels subcommand '$sub'"; echo "usage: tlon-run channels {dms|group-dms|groups|all}"; exit 2 ;;
    esac
    exec node "$DIST_DIR/channels.js" "$sub"
    ;;

  contacts)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec node "$DIST_DIR/contacts.js" list
        ;;
      self)
        exec node "$DIST_DIR/contacts.js" self
        ;;
      get)
        who="${1:-}"
        [ -n "$who" ] || { echo "error: missing ship name"; echo "usage: tlon-run contacts get ~ship-name"; exit 2; }
        validate_ship "$who"
        exec node "$DIST_DIR/contacts.js" get "$who"
        ;;
      *)
        echo "error: unknown contacts subcommand '$sub'"
        echo "usage: tlon-run contacts {list|self|get ~ship}"
        exit 2
        ;;
    esac
    ;;

  groups)
    sub="${1:-}"
    shift || true
    case "$sub" in
      list)
        exec node "$DIST_DIR/groups.js" list
        ;;
      info)
        grp="${1:-}"
        [ -n "$grp" ] || { echo "error: missing group"; echo "usage: tlon-run groups info ~host-ship/group-slug"; exit 2; }
        validate_group "$grp"
        exec node "$DIST_DIR/groups.js" info "$grp"
        ;;
      *)
        echo "error: unknown groups subcommand '$sub'"
        echo "usage: tlon-run groups {list|info ~host/slug}"
        exit 2
        ;;
    esac
    ;;

  messages)
    sub="${1:-}"
    shift || true
    case "$sub" in
      dm)
        ship="${1:-}"
        [ -n "$ship" ] || { echo "error: missing ship"; echo "usage: tlon-run messages dm ~ship [--limit N]"; exit 2; }
        validate_ship "$ship"
        shift

        if [ "${1:-}" = "--limit" ]; then
          limit="${2:-}"
          validate_limit "$limit" 50
          exec node "$DIST_DIR/messages.js" dm "$ship" --limit "$limit"
        else
          exec node "$DIST_DIR/messages.js" dm "$ship"
        fi
        ;;
      channel|history)
        chan="${1:-}"
        [ -n "$chan" ] || { echo "error: missing channel"; echo "usage: tlon-run messages channel chat/~host/slug [--limit N]"; exit 2; }
        validate_channel "$chan"
        shift

        if [ "${1:-}" = "--limit" ]; then
          limit="${2:-}"
          validate_limit "$limit" 50
          exec node "$DIST_DIR/messages.js" "$sub" "$chan" --limit "$limit"
        else
          exec node "$DIST_DIR/messages.js" "$sub" "$chan"
        fi
        ;;
      *)
        echo "error: unknown messages subcommand '$sub'"
        echo "usage: tlon-run messages {dm ~ship|channel chat/~host/slug|history chat/~host/slug} [--limit N]"
        exit 2
        ;;
    esac
    ;;

  "")
    echo "error: no command specified"
    echo "usage: tlon-run {activity|channels|contacts|groups|messages|help}"
    exit 2
    ;;

  *)
    echo "error: unknown command '$cmd'"
    echo "usage: tlon-run {activity|channels|contacts|groups|messages|help}"
    exit 2
    ;;
esac
